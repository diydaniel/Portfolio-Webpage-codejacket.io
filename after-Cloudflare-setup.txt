üìò Passwordless Authentication Implementation (Cloudflare Workers + Resend)
üõ† Overview

This guide covers the steps taken to implement a secure passwordless login system on Cloudflare Workers using:

Resend for sending transactional magic-link emails

Cloudflare KV for one-time token storage

JWT sessions stored in HttpOnly cookies

1. Environment Setup
1.1 Installed Dependencies

Configured wrangler CLI

npm install --save-dev wrangler@latest


Created a Cloudflare Workers project with modular route handlers.

1.2 Generated and Saved Secrets

Used Wrangler to store sensitive secrets:

npx wrangler secret put RESEND_API_KEY
npx wrangler secret put SESSION_JWT_SECRET


This ensures the Worker has secure access to:

Resend API for sending emails

JWT secret for session signing

2. DNS & Resend Domain Verification

To ensure mailbox providers would accept authentication emails:

2.1 Verified Sending Subdomain

Verified a subdomain mail.codejacket.io in the Resend dashboard.

Added required DNS records in Cloudflare:

DKIM (TXT) ‚Äî verified

SPF (TXT) ‚Äî verified

This ensured Resend could send authenticated email on your behalf.

Note: The optional MX record Resend showed can break inbound mail at the root domain, so we used only SPF/DKIM for sending.

2.2 Confirmed Verified Status

The Resend dashboard showed:

Status: Verified


Both DKIM and SPF DNS records were verified successfully.

3. Passwordless Auth Flow

Your Worker now contains the following:

3.1 /auth/start ‚Äî Magic Link Request

Handler: cloudflare/auth/start.js

Receives { email } in request body

Generates a random one-time token

Hashes and stores the token in Cloudflare KV with TTL

Constructs a magic link with the raw token

Sends email via Resend

Successful JSON response:

{"sent": true}

3.2 /auth/verify ‚Äî Token Verification & Session

Handler: cloudflare/auth/verify.js

Reads token query parameter

Hashes and compares to KV entry

Deletes stored token (one-time use)

Signs a JWT with SESSION_JWT_SECRET

Sets an HttpOnly cj_session cookie on success

Redirects to front-end dashboard

Example cookie header:

Set-Cookie: cj_session=<JWT>; Path=/; HttpOnly; Secure; SameSite=Lax; Max-Age=604800


Response on success:

HTTP/2 302
Location: https://codejacket.io/dashboard.html

4. Utility Modules Created
4.1 Token Generator

cloudflare/utils/token.js

export function generateToken() { ‚Ä¶ }
export async function hashToken(token) { ‚Ä¶ }


Used for generating secure magic tokens and hashing for KV storage.

4.2 Resend Email Helper

cloudflare/utils/email.js

export async function sendMagicLinkEmail(env, to, magicLink) { ‚Ä¶ }


Sends transactional email via Resend API.

4.3 JWT Session Helper

cloudflare/utils/jwt.js

export async function signJWT(payload, secret, ttl) { ‚Ä¶ }


Creates a signed JWT for session cookie.

5. Testing & Verification
5.1 Tested Email Delivery

After domain verification, a real inbox was used to receive a magic link.

The magic link token was extracted reliably from the received email.

5.2 Token Verification

Ran:

curl -i "https://codejacket-api.codejacket.workers.dev/auth/verify?token=ACTUAL_TOKEN"


Confirmed:

Cookie was properly set

Redirect to front-end occurred

6. Next Logical Pieces (Planned)

You‚Äôve successfully completed the core authentication path. Future additions might include:

‚úî Front-end integration (login form + callback)
‚úî Logout endpoint that clears session cookie
‚úî Token expiration and renewal strategies
‚úî User profiles and account metadata handling
‚úî Rate limiting and abuse protection
‚úî Integration with paid content access and Stripe entitlement logic

üöÄ Summary

You now have a fully functioning passwordless login system on Cloudflare Workers with:

üìç Magic link email delivery using Resend
üìç Secure one-time tokens stored in Cloudflare KV
üìç JWT session cookies for persistent login
üìç Verified domain setup for inbox deliverability

Your magic link is usable, and session cookies are being set correctly.


‚õì Deployment Notes

To continue building on this foundation:

Keep your secrets (especially JWT secret) secure

Use Cloudflare KV for state you want available globally

Ensure DNS propagation completes before expecting inbox delivery

Protect routes with JWT verification via /me and similar handlers